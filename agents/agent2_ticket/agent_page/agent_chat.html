<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Agent2 Ticket - Chat Interface</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }

            .chat-container {
                width: 100%;
                max-width: 800px;
                background: #ffffff;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                text-align: center;
            }

            .chat-header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }

            .chat-header p {
                opacity: 0.8;
                font-size: 0.9rem;
            }

            .chat-messages {
                height: 450px;
                overflow-y: auto;
                padding: 20px;
                background: #f8f9fa;
            }

            .message {
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
            }

            .message.user {
                align-items: flex-end;
            }

            .message.assistant {
                align-items: flex-start;
            }

            .message-content {
                max-width: 70%;
                padding: 12px 16px;
                border-radius: 16px;
                line-height: 1.5;
            }

            .message.user .message-content {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-bottom-right-radius: 4px;
            }

            .message.assistant .message-content {
                background: white;
                color: #333;
                border-bottom-left-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .message-meta {
                font-size: 0.75rem;
                color: #888;
                margin-top: 4px;
            }

            .chat-input-area {
                display: flex;
                padding: 20px;
                background: white;
                border-top: 1px solid #e9ecef;
                gap: 10px;
            }

            .chat-input {
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 24px;
                font-size: 1rem;
                outline: none;
                transition: border-color 0.3s;
            }

            .chat-input:focus {
                border-color: #667eea;
            }

            .send-btn {
                padding: 12px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 24px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .send-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .send-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .clear-btn {
                padding: 12px 16px;
                background: #f8f9fa;
                color: #666;
                border: 2px solid #e9ecef;
                border-radius: 24px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
            }

            .clear-btn:hover {
                background: #ffebee;
                border-color: #f44336;
                color: #c62828;
            }

            .loading {
                display: flex;
                gap: 4px;
                padding: 12px 16px;
            }

            .loading span {
                width: 8px;
                height: 8px;
                background: #667eea;
                border-radius: 50%;
                animation: bounce 1.4s infinite ease-in-out;
            }

            .loading span:nth-child(1) {
                animation-delay: -0.32s;
            }

            .loading span:nth-child(2) {
                animation-delay: -0.16s;
            }

            @keyframes bounce {

                0%,
                80%,
                100% {
                    transform: scale(0);
                }

                40% {
                    transform: scale(1);
                }
            }

            .status-bar {
                padding: 8px 20px;
                background: #e8f5e9;
                color: #2e7d32;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .status-bar.error {
                background: #ffebee;
                color: #c62828;
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #4caf50;
            }

            .status-bar.error .status-dot {
                background: #f44336;
            }
        </style>
    </head>

    <body>
        <div class="chat-container">
            <div class="chat-header">
                <h1>Agent WSB Merito</h1>
                <p>Postaram siƒô odpowiedzieƒá na Twoje pytania!</p>
            </div>

            <div class="status-bar" id="statusBar">
                <span class="status-dot"></span>
                <span id="statusText">Ready - Agent 2 Ticket (port 8002)</span>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">Cze≈õƒá jestem Adam - Tw√≥j inteligƒôtny pracownik BOS, w czym Ci mogƒô
                        pom√≥c?</div>
                    <div class="message-meta">WSB Merito</div>
                </div>
            </div>

            <div class="chat-input-area">
                <button class="clear-btn" id="clearBtn" title="Nowa rozmowa">üóëÔ∏è</button>
                <input type="text" class="chat-input" id="userInput" placeholder="Zadaj mi pytanie.." autofocus>
                <button class="send-btn" id="sendBtn">Wy≈õlij</button>
            </div>
        </div>

        <script>
            const AGENT_PORT = 8002;
            const AGENT_NAME = 'Agent 2 - Ticket';

            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearBtn');
            const statusText = document.getElementById('statusText');
            const statusBar = document.getElementById('statusBar');

            const WELCOME_MESSAGE = 'Cze≈õƒá jestem Adam - Tw√≥j inteligƒôtny pracownik BOS, w czym Ci mogƒô pom√≥c?';

            function clearChat() {
                chatMessages.innerHTML = '';
                addMessage(WELCOME_MESSAGE, 'assistant', 'WSB Merito');
                userInput.focus();
            }

            clearBtn.addEventListener('click', clearChat);

            function addMessage(content, type, meta = '') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                metaDiv.textContent = meta || (type === 'user' ? 'You' : AGENT_NAME);

                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(metaDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message assistant';
                loadingDiv.id = 'loadingMessage';
                loadingDiv.innerHTML = `
                <div class="loading">
                    <span></span><span></span><span></span>
                </div>
            `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function removeLoading() {
                const loading = document.getElementById('loadingMessage');
                if (loading) loading.remove();
            }

            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                addMessage(message, 'user');
                userInput.value = '';
                sendBtn.disabled = true;
                addLoading();

                try {
                    const response = await fetch(`http://localhost:${AGENT_PORT}/run`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ input: message }),
                    });

                    removeLoading();

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    // Handle the ticket_classification response
                    const result = data.ticket_classification || data.result || data.response || JSON.stringify(data, null, 2);
                    addMessage(result, 'assistant');
                    statusBar.classList.remove('error');
                    statusText.textContent = `Ready - ${AGENT_NAME} (port ${AGENT_PORT})`;

                } catch (error) {
                    removeLoading();
                    let errorMsg = error.message;
                    if (error.message.includes('Load failed') || error.message.includes('Failed to fetch')) {
                        errorMsg = `Cannot connect to agent. Please ensure:\n1. Docker containers are running (docker-compose up -d)\n2. Agent 2 is healthy on port ${AGENT_PORT}`;
                    }
                    addMessage(errorMsg, 'assistant', 'Error');
                    statusBar.classList.add('error');
                    statusText.textContent = `Connection failed - port ${AGENT_PORT}`;
                }

                sendBtn.disabled = false;
                userInput.focus();
            }

            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Check connection on load
            async function checkConnection() {
                try {
                    const response = await fetch(`http://localhost:${AGENT_PORT}/docs`, { method: 'HEAD' });
                    statusBar.classList.remove('error');
                    statusText.textContent = `Connected - ${AGENT_NAME} (port ${AGENT_PORT})`;
                } catch (e) {
                    statusBar.classList.add('error');
                    statusText.textContent = `Waiting for agent on port ${AGENT_PORT}...`;
                }
            }
            checkConnection();
        </script>
    </body>

</html>